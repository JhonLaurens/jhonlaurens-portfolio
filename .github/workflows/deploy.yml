name: Deploy Portfolio

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build -f deployment/docker/Dockerfile -t portfolio:latest .

      - name: Test Container
        run: |
          # Ejecutar contenedor
          docker run -d -p 8080:80 --name test-portfolio portfolio:latest

          # Verificar que el contenedor est√° corriendo
          sleep 5
          if ! docker ps | grep test-portfolio; then
            echo "‚ùå Container failed to start"
            docker logs test-portfolio
            exit 1
          fi

          # Verificar nginx est√° corriendo dentro del contenedor
          docker exec test-portfolio nginx -t
          if [ $? -ne 0 ]; then
            echo "‚ùå Nginx configuration test failed"
            docker logs test-portfolio
            exit 1
          fi

          # Test HTTP con reintentos
          echo "üåê Testing HTTP access..."
          for i in {1..10}; do
            if curl -s -f http://localhost:8080 > /dev/null; then
              echo "‚úÖ HTTP test successful on attempt $i"
              break
            else
              echo "‚è±Ô∏è HTTP test attempt $i failed, retrying in 3s..."
              sleep 3
              if [ $i -eq 10 ]; then
                echo "‚ùå HTTP test failed after 10 attempts"
                docker logs test-portfolio
                docker ps | grep test-portfolio
                exit 1
              fi
            fi
          done

          # Limpiar
          docker stop test-portfolio
          docker rm test-portfolio

      - name: Build Production Image
        run: |
          docker build -f deployment/docker/Dockerfile.prod -t jhonlaurens/portfolio:latest .

      - name: Security Scan
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $PWD:/tmp/app \
            aquasec/trivy image jhonlaurens/portfolio:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to production
        run: |
          echo "Deployment would happen here"
          # Add your deployment logic
